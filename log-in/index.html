<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="/files/user-interface.js"></script>
</head>
<body>
    <h1>Login</h1>
    
    <!-- Google Sign-In Button -->
    <button id="google-sign-in">Sign in with Google</button>

    <!-- Email and Password login -->
    <div id="email-password-login">
        <h2>Email & Password Login</h2>
        <input type="email" id="email" placeholder="Enter your email" required>
        <input type="password" id="password" placeholder="Enter your password" required>
        <button id="email-login">Login</button>
        <button id="email-register">Register</button>
    </div>
    
    <!-- Profile Display -->
    <div id="profile" style="display:none;">
        <img id="profile-picture" src="" alt="Profile Picture" />
        <p id="user-name"></p>
        <input type="text" id="edit-username" placeholder="Edit your username">
        <button id="save-username">Save Username</button>
        <button id="sign-out">Sign Out</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc2p_OYkuo1IYw4xc-0NYn0M5VtMf-iVI",
            authDomain: "mertek-archive-site-login.firebaseapp.com",
            projectId: "mertek-archive-site-login",
            storageBucket: "mertek-archive-site-login.firebasestorage.app",
            messagingSenderId: "194382051161",
            appId: "1:194382051161:web:21e9ea763a0d59bd33be48",
            measurementId: "G-FTYTP99H96"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();

        // Google Sign-In Button
        const googleSignInButton = document.getElementById('google-sign-in');
        const profileSection = document.getElementById('profile');
        const signOutButton = document.getElementById('sign-out');
        const saveUsernameButton = document.getElementById('save-username');
        const editUsernameInput = document.getElementById('edit-username');
        
        // Email and Password
        const emailLoginButton = document.getElementById('email-login');
        const emailRegisterButton = document.getElementById('email-register');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    console.log('Signed in as:', user.displayName);
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error during Google sign-in:", error.message);
                    alert("Error: " + error.message);
                });
        });

        signOutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                console.log('User signed out');
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block';
            }).catch((error) => {
                console.error("Error signing out:", error.message);
            });
        });

        // Save the new username
        saveUsernameButton.addEventListener('click', () => {
            const user = auth.currentUser;
            const newUsername = editUsernameInput.value;
            if (newUsername) {
                const userRef = firestore.collection('users').doc(user.uid);
                userRef.update({ username: newUsername })
                    .then(() => {
                        alert("Username updated successfully!");
                        document.getElementById('user-name').innerText = `Welcome, ${newUsername}`;
                    })
                    .catch((error) => {
                        console.error("Error updating username:", error.message);
                    });
            } else {
                alert("Please enter a valid username.");
            }
        });

        // Handle user sign-in
        function handleUserSignIn(user) {
            googleSignInButton.style.display = 'none';
            profileSection.style.display = 'block';

            // Set user profile details
            document.getElementById('profile-picture').src = user.photoURL;
            document.getElementById('user-name').innerText = `Welcome, ${user.displayName}`;
            editUsernameInput.value = user.displayName;

            // Check if the user exists in Firestore
            const userRef = firestore.collection('users').doc(user.uid);
            userRef.get().then(doc => {
                if (!doc.exists) {
                    // New user, create a document with their username
                    const username = prompt("Please choose a username for your profile:", user.displayName);
                    userRef.set({ username: username })
                        .then(() => {
                            console.log('New user profile created with username:', username);
                        })
                        .catch(error => {
                            console.error("Error creating user profile:", error.message);
                        });
                }
            }).catch(error => {
                console.error("Error checking user document:", error.message);
            });
        }

        // Email and Password Login
        emailLoginButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("Logged in as:", user.email);
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error during email login:", error.message);
                    alert("Error: " + error.message);
                });
        });

        // Email and Password Register
        emailRegisterButton.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log("Registered as:", user.email);
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error during email registration:", error.message);
                    alert("Error: " + error.message);
                });
        });

        // Monitor authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                handleUserSignIn(user);
            } else {
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block';
            }
        });
    </script>
</body>
</html>
