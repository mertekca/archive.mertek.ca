<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="/files/user-interface.js"></script>
</head>
<body>
    <h1>Login</h1>

    <!-- Google Sign-In Button -->
    <button id="google-sign-in">Sign in with Google</button>

    <!-- Email/Password Login -->
    <div id="email-password-login">
        <h3>Login with Email and Password</h3>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="login-email">Login</button>
        <button id="register-email">Register</button>
    </div>

    <!-- Profile Display -->
    <div id="profile" style="display:none;">
        <img id="profile-picture" src="" alt="Profile Picture" />
        <p id="user-name"></p>
        <input type="text" id="edit-username" placeholder="Edit Username" />
        <button id="save-username">Save Username</button>
        <input type="file" id="file-upload" accept="image/*" />
        <button id="upload-picture">Upload Picture</button>
        <button id="sign-out">Sign Out</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc2p_OYkuo1IYw4xc-0NYn0M5VtMf-iVI",
            authDomain: "mertek-archive-site-login.firebaseapp.com",
            projectId: "mertek-archive-site-login",
            storageBucket: "mertek-archive-site-login.appspot.com",
            messagingSenderId: "194382051161",
            appId: "1:194382051161:web:21e9ea763a0d59bd33be48",
            measurementId: "G-FTYTP99H96"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        // DOM elements
        const googleSignInButton = document.getElementById('google-sign-in');
        const emailPasswordLogin = document.getElementById('email-password-login');
        const profileSection = document.getElementById('profile');
        const signOutButton = document.getElementById('sign-out');
        const editUsernameInput = document.getElementById('edit-username');
        const saveUsernameButton = document.getElementById('save-username');
        const userNameElement = document.getElementById('user-name');
        const profilePicture = document.getElementById('profile-picture');
        const fileUpload = document.getElementById('file-upload');
        const uploadPictureButton = document.getElementById('upload-picture');
        const loginEmailButton = document.getElementById('login-email');
        const registerEmailButton = document.getElementById('register-email');

        // Google Sign-In
        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    const user = result.user;
                    console.log('Signed in as:', user.displayName);
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error during Google sign-in:", error.message);
                    alert("Error: " + error.message);
                });
        });

        // Email and Password Login/Registration
        loginEmailButton.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error logging in:", error.message);
                    alert("Error: " + error.message);
                });
        });

        registerEmailButton.addEventListener('click', () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    handleUserSignIn(user);
                })
                .catch((error) => {
                    console.error("Error registering:", error.message);
                    alert("Error: " + error.message);
                });
        });

        // Save updated username
        saveUsernameButton.addEventListener('click', () => {
            const newUsername = editUsernameInput.value.trim();
            if (newUsername) {
                const user = auth.currentUser;
                const userRef = firestore.collection('users').doc(user.uid);
                userRef.update({
                    username: newUsername
                }).then(() => {
                    console.log('Username updated to:', newUsername);
                    userNameElement.innerText = `Welcome, ${newUsername}`;
                }).catch((error) => {
                    console.error("Error updating username:", error.message);
                });
            } else {
                alert("Please enter a valid username.");
            }
        });

        // Upload profile picture
        uploadPictureButton.addEventListener('click', () => {
            const file = fileUpload.files[0];
            if (file) {
                const user = auth.currentUser;
                const storageRef = storage.ref().child(`profile_pictures/${user.uid}/${file.name}`);
                const uploadTask = storageRef.put(file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        console.error("Error uploading picture:", error.message);
                    },
                    () => {
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('File available at', downloadURL);
                            const userRef = firestore.collection('users').doc(user.uid);
                            userRef.update({
                                photoURL: downloadURL
                            }).then(() => {
                                profilePicture.src = downloadURL;
                            }).catch((error) => {
                                console.error("Error updating profile picture URL:", error.message);
                            });
                        });
                    }
                );
            } else {
                alert("Please select a file to upload.");
            }
        });

        // Sign-out
        signOutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block'; // Show login options again
            }).catch((error) => {
                console.error("Error signing out:", error.message);
            });
        });

        // Handle user sign-in and profile display
        function handleUserSignIn(user) {
            googleSignInButton.style.display = 'none';
            emailPasswordLogin.style.display = 'none'; // Hide email/password login after sign-in
            profileSection.style.display = 'block';

            profilePicture.src = user.photoURL;
            userNameElement.innerText = `Welcome, ${user.displayName || user.email}`;

            // Check if it's the first time the user is signing in
            const userRef = firestore.collection('users').doc(user.uid);
            userRef.get().then(doc => {
                if (!doc.exists) {
                    // New user, create a document with their username
                    const username = prompt("Please choose a username for your profile:", user.displayName || user.email);
                    userRef.set({
                        username: username,
                        photoURL: user.photoURL || ""
                    }).then(() => {
                        console.log('New user profile created with username:', username);
                        userNameElement.innerText = `Welcome, ${username}`;
                    }).catch(error => {
                        console.error("Error creating user profile:", error.message);
                    });
                } else {
                    const username = doc.data().username;
                    const photoURL = doc.data().photoURL;
                    userNameElement.innerText = `Welcome, ${username}`;
                    profilePicture.src = photoURL || "";
                }
            }).catch(error => {
                console.error("Error checking user document:", error.message);
            });
        }

        // Monitor authentication state
        auth.onAuthStateChanged((user) => {
            if (user) {
                handleUserSignIn(user);
            } else {
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block'; // Display email/password login again
            }
        });
    </script>
</body>
</html>
