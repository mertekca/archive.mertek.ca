<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="/files/user-interface.js"></script>
</head>
<body>
    <h1>Login</h1>

    <!-- Google Sign-In Button -->
    <button id="google-sign-in">Sign in with Google</button>

    <!-- Email/Password Login -->
    <div id="email-password-login">
        <h3>Login with Email and Password</h3>
        <input type="email" id="email" placeholder="Email" required>
        <input type="password" id="password" placeholder="Password" required>
        <button id="login-email">Login</button>
        <button id="register-email">Register</button>
    </div>

    <!-- Profile Display -->
    <div id="profile" style="display:none;">
        <img id="profile-picture" src="" alt="Profile Picture" />
        <input type="file" id="profile-picture-input" accept="image/*" style="display: none;">
        <button id="upload-picture">Upload Profile Picture</button>
        <p id="user-name"></p>
        <input type="text" id="edit-username" placeholder="Edit Username" />
        <button id="save-username">Save Username</button>
        <button id="sign-out">Sign Out</button>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        const storage = firebase.storage();

        // DOM elements
        const googleSignInButton = document.getElementById('google-sign-in');
        const emailPasswordLogin = document.getElementById('email-password-login');
        const profileSection = document.getElementById('profile');
        const signOutButton = document.getElementById('sign-out');
        const editUsernameInput = document.getElementById('edit-username');
        const saveUsernameButton = document.getElementById('save-username');
        const userNameElement = document.getElementById('user-name');
        const profilePicture = document.getElementById('profile-picture');
        const uploadPictureButton = document.getElementById('upload-picture');
        const profilePictureInput = document.getElementById('profile-picture-input');

        // Google Sign-In
        googleSignInButton.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                handleUserSignIn(result.user);
            }).catch(error => alert("Error: " + error.message));
        });

        // Save updated username
        saveUsernameButton.addEventListener('click', () => {
            const newUsername = editUsernameInput.value.trim();
            if (newUsername) {
                const user = auth.currentUser;
                const userRef = firestore.collection('users').doc(user.uid);
                userRef.set({ username: newUsername }, { merge: true }).then(() => {
                    userNameElement.innerText = `Welcome, ${newUsername}`;
                });
            }
        });

        // Upload Profile Picture
        uploadPictureButton.addEventListener('click', () => {
            profilePictureInput.click();
        });

        profilePictureInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const user = auth.currentUser;
                const storageRef = storage.ref(`profilePictures/${user.uid}`);
                storageRef.put(file).then(() => {
                    storageRef.getDownloadURL().then(url => {
                        profilePicture.src = url;
                        firestore.collection('users').doc(user.uid).set({ profilePicture: url }, { merge: true });
                    });
                });
            }
        });

        // Handle user sign-in
        function handleUserSignIn(user) {
            googleSignInButton.style.display = 'none';
            emailPasswordLogin.style.display = 'none';
            profileSection.style.display = 'block';
            profilePicture.src = user.photoURL || "default-avatar.png";

            const userRef = firestore.collection('users').doc(user.uid);
            userRef.get().then(doc => {
                if (!doc.exists) {
                    userRef.set({ username: user.displayName || user.email });
                    editUsernameInput.value = user.displayName || user.email;
                } else {
                    const data = doc.data();
                    editUsernameInput.value = data.username;
                    userNameElement.innerText = `Welcome, ${data.username}`;
                    if (data.profilePicture) profilePicture.src = data.profilePicture;
                }
            });
        }

        // Monitor authentication state
        auth.onAuthStateChanged(user => {
            if (user) handleUserSignIn(user);
            else {
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block';
            }
        });

        // Sign out
        signOutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                profileSection.style.display = 'none';
                googleSignInButton.style.display = 'inline-block';
                emailPasswordLogin.style.display = 'block';
            });
        });
    </script>
</body>
</html>
